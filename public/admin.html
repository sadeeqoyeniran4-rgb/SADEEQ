<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f9; }
    header { background: #333; color: #fff; padding: 1rem; text-align: center; }
    .container {
      max-width: 950px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none;
    }
    h2 { margin-top: 0; }
    input, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    button { background: #333; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #555; }
    #productResponse, #loginResponse { margin-top: 10px; font-weight: bold; }
    #admin-login-modal {
      display: flex; justify-content: center; align-items: center;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: white; padding: 2rem; border-radius: 8px;
      width: 90%; max-width: 400px; text-align: center;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
    img { max-width: 80px; height: auto; display: block; }
    .delete-btn {
      background: red; color: white; border: none;
      padding: 6px 10px; border-radius: 5px; cursor: pointer;
    }
    .edit-btn {
      background: #007bff; color: white; border: none;
      padding: 6px 10px; border-radius: 5px; cursor: pointer;
      margin-right: 5px;
    }
    .delete-btn:hover { background: darkred; }
    .edit-btn:hover { background: #0056b3; }
    #edit-modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
    }
    #edit-modal .modal-box {
      background: #fff; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 400px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Admin Dashboard</h1>
  </header>

  <!-- Login Modal -->
  <div id="admin-login-modal">
    <div class="modal-content">
      <h2>ðŸ”‘ Admin Login</h2>
      <form id="adminLoginForm">
        <input type="password" id="admin-password" placeholder="Enter admin password" required>
        <button type="submit">Login</button>
      </form>
      <p id="loginResponse"></p>
    </div>
  </div>

  <!-- Add Product Section -->
  <div id="admin-section" class="container">
    <h2>Add New Product</h2>
    <form id="addProductForm">
      <input type="text" id="prod-name" placeholder="Product Name" required>
      <textarea id="prod-desc" placeholder="Product Description"></textarea>
      <input type="number" id="prod-price" placeholder="Price (â‚¦)" required>
      <input type="file" id="prod-image-file" accept="image/*" required>
      <button type="submit" id="addProductBtn">Add Product</button>
    </form>
    <p id="productResponse"></p>
  </div>

  <!-- Product List Section -->
  <div id="product-list-section" class="container">
    <h2>All Products</h2>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Image</th>
          <th>Name</th>
          <th>Price (â‚¦)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productTableBody"></tbody>
    </table>
  </div>

  <!-- Orders Section -->
<div id="orders-section" class="container">
  <h2>Orders</h2>
  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Email</th>
        <th>Address</th>
        <th>Items</th>
        <th>Total (â‚¦)</th>
        <th>Status</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>
</div>

  <!-- Edit Modal -->
  <div id="edit-modal">
    <div class="modal-box">
      <h2>Edit Product</h2>
      <form id="editProductForm">
        <input type="hidden" id="edit-id">
        <input type="text" id="edit-name" placeholder="Product Name" required>
        <textarea id="edit-desc" placeholder="Product Description"></textarea>
        <input type="number" id="edit-price" placeholder="Price (â‚¦)" required>
        <input type="file" id="edit-image-file" accept="image/*">
        <button type="submit">Save Changes</button>
        <button type="button" onclick="closeEditModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    let adminToken = null;

    const adminLoginForm = document.getElementById('adminLoginForm');
    const adminModal = document.getElementById('admin-login-modal');
    const adminSection = document.getElementById('admin-section');
    const productListSection = document.getElementById('product-list-section');
    const ordersSection = document.getElementById('orders-section');
    const loginResponse = document.getElementById('loginResponse');
    const editModal = document.getElementById('edit-modal');

    // Admin Login
    adminLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('admin-password').value;

      const res = await fetch('https://lofinda-backend.onrender.com/api/admin-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const data = await res.json();
      if (data.success) {
        adminToken = data.token;
        adminModal.style.display = 'none';
        adminSection.style.display = 'block';
        productListSection.style.display = 'block';
        ordersSection.style.display = 'block';
        fetchProducts();
        fetchOrders();
      } else {
        loginResponse.textContent = 'âŒ Incorrect password';
      }
    });

    // Add product
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('prod-name').value;
      const desc = document.getElementById('prod-desc').value;
      const price = document.getElementById('prod-price').value;
      const imageFile = document.getElementById('prod-image-file').files[0];

      // Step 1: Upload image
      const imgData = new FormData();
      imgData.append("image", imageFile);

      const uploadRes = await fetch('https://lofinda-backend.onrender.com/api/upload', {
        method: 'POST',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: imgData
      });
      const uploadData = await uploadRes.json();
      if (!uploadData.success) {
        alert("Image upload failed");
        return;
      }

      // Step 2: Add product
      const res = await fetch('https://lofinda-backend.onrender.com/api/products', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${adminToken}`
        },
        body: JSON.stringify({
          name: name,
          description: desc,
          price: price,
          image_url: uploadData.url
        })
      });

      if (res.ok) {
        document.getElementById('productResponse').textContent = 'âœ… Product added!';
        document.getElementById('addProductForm').reset();
        fetchProducts();
      } else {
        document.getElementById('productResponse').textContent = 'âŒ Error adding product';
      }
    });

    // Fetch products
    async function fetchProducts() {
    const res = await fetch('https://lofinda-backend.onrender.com/api/products');
      const products = await res.json();
      const tbody = document.getElementById('productTableBody');
      tbody.innerHTML = '';
      products.forEach(prod => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${prod.id}</td>
          <td><img src="${prod.image_url}" alt="${prod.name}"></td>
          <td>${prod.name}</td>
          <td>â‚¦${prod.price}</td>
          <td>
            <button class="edit-btn" onclick="openEditModal(${prod.id}, '${prod.name}', '${prod.description}', ${prod.price})">Edit</button>
            <button class="delete-btn" onclick="deleteProduct(${prod.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Delete product
    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      const res = await fetch(`/api/products/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${adminToken}` }
      });
      if (res.ok) fetchProducts();
    }

    // Edit modal
    function openEditModal(id, name, description, price) {
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-name').value = name;
      document.getElementById('edit-desc').value = description;
      document.getElementById('edit-price').value = price;
      editModal.style.display = 'flex';
    }
    function closeEditModal() {
      editModal.style.display = 'none';
    }

    // Save edit
    document.getElementById('editProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-id').value;
      const name = document.getElementById('edit-name').value;
      const desc = document.getElementById('edit-desc').value;
      const price = document.getElementById('edit-price').value;

      const res = await fetch(`/api/products/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${adminToken}`
        },
        body: JSON.stringify({ name, description: desc, price })
      });

      if (res.ok) {
        fetchProducts();
        closeEditModal();
      }
    });

   // Fetch Orders and Display Order Items, Qty, Price
  async function fetchOrders() {
    const res = await fetch('https://lofinda-backend.onrender.com/api/orders', {
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const orders = await res.json();
    const tbody = document.getElementById('ordersBody');
    tbody.innerHTML = '';

    orders.forEach(order => {
      const tr = document.createElement('tr');

      const itemsHtml = order.items && order.items.length > 0
        ? order.items.map(item => `
            <div>
              ${item.product_name} (x${item.quantity}) - â‚¦${item.price}
            </div>
          `).join('')
        : '<em>No items</em>';

      tr.innerHTML = `
        <td>${order.id}</td>
        <td>${order.customer_name || 'N/A'}</td>
        <td>${order.email || 'N/A'}</td>
        <td>${order.address || 'N/A'}</td>
        <td>${itemsHtml}</td>
        <td>â‚¦${order.total_amount}</td>
        <td>${order.status || 'Pending'}</td>
        <td>${new Date(order.created_at).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

    window.deleteProduct = deleteProduct;
    window.openEditModal = openEditModal;
  </script>
</body>
</html>
